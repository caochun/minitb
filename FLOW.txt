MiniTB æ ¸å¿ƒæ•°æ®æµå¯è§†åŒ–
================================================================================

è®¾å¤‡æ•°æ®ä¸ŠæŠ¥å®Œæ•´æµç¨‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å±‚: IoTè®¾å¤‡                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                     MQTT PUBLISHæ¶ˆæ¯
                     Topic: v1/devices/me/telemetry
                     Payload: {"temperature":25}
                     Token: test-token-001
                                â”‚
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2å±‚: MQTTä¼ è¾“å±‚ (MqttTransportHandler)                               â”‚
â”‚                                                                        â”‚
â”‚  channelRead0() â†’ handlePublish()                                     â”‚
â”‚     â€¢ è§£æ topic: v1/devices/me/telemetry                             â”‚
â”‚     â€¢ æå– payload: {"temperature":25}                                â”‚
â”‚     â€¢ æå– token: test-token-001                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
          transportService.processTelemetry(token, json)
                                â”‚
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3å±‚: ä¼ è¾“æœåŠ¡ (TransportService)                                     â”‚
â”‚                                                                        â”‚
â”‚  Step 1: authenticateDevice(token)                                    â”‚
â”‚          â†’ Device{name="æ¸©åº¦ä¼ æ„Ÿå™¨-01", id=xxx}                        â”‚
â”‚                                                                        â”‚
â”‚  Step 2: checkRateLimit(device)                                       â”‚
â”‚          â†’ true (é€šè¿‡æ£€æŸ¥)                                             â”‚
â”‚                                                                        â”‚
â”‚  Step 3: åˆ›å»ºTbMsg ğŸ”¥æ ¸å¿ƒè½¬æ¢ç‚¹ğŸ”¥                                      â”‚
â”‚          TbMsg.builder()                                              â”‚
â”‚              .type(POST_TELEMETRY_REQUEST)                            â”‚
â”‚              .originator(device.getId())                              â”‚
â”‚              .metaData({deviceName, deviceType, ts})                  â”‚
â”‚              .data("{\"temperature\":25}")                            â”‚
â”‚              .build()                                                 â”‚
â”‚                                                                        â”‚
â”‚  Step 4: sendToRuleEngine(tbMsg)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                      ruleEngineService.processMessage(tbMsg)
                                â”‚
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬4å±‚: è§„åˆ™å¼•æ“æœåŠ¡ (RuleEngineService)                                â”‚
â”‚                                                                        â”‚
â”‚  å¼‚æ­¥å¤„ç†:                                                             â”‚
â”‚    executorService.submit(() -> {                                     â”‚
â”‚        RuleChain chain = selectRuleChain(msg);                        â”‚
â”‚        chain.process(msg);                                            â”‚
â”‚    })                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                        rootRuleChain.process(msg)
                                â”‚
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬5å±‚: è§„åˆ™é“¾æ‰§è¡Œ (RuleChain)                                          â”‚
â”‚                                                                        â”‚
â”‚  èŠ‚ç‚¹1: LogNode[å…¥å£æ—¥å¿—]                                              â”‚
â”‚    onMsg(msg) â†’ æ‰“å°æ—¥å¿— â†’ è¿”å›msg                                     â”‚
â”‚         â†“                                                             â”‚
â”‚  èŠ‚ç‚¹2: FilterNode[temperature > 20.0]                                â”‚
â”‚    onMsg(msg) â†’ æ£€æŸ¥æ¡ä»¶(25>20) â†’ è¿”å›msg                             â”‚
â”‚         â†“                                                             â”‚
â”‚  èŠ‚ç‚¹3: LogNode[è¿‡æ»¤åæ—¥å¿—]                                            â”‚
â”‚    onMsg(msg) â†’ æ‰“å°æ—¥å¿— â†’ è¿”å›msg                                     â”‚
â”‚         â†“                                                             â”‚
â”‚  èŠ‚ç‚¹4: SaveTelemetryNode                                             â”‚
â”‚    onMsg(msg) â†’ storage.save() â†’ è¿”å›msg                              â”‚
â”‚         â†“                                                             â”‚
â”‚  èŠ‚ç‚¹5: LogNode[ä¿å­˜å®Œæˆ]                                              â”‚
â”‚    onMsg(msg) â†’ æ‰“å°æ—¥å¿— â†’ è¿”å›msg                                     â”‚
â”‚         â†“                                                             â”‚
â”‚       å®Œæˆ                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    storage.save(deviceId, ts, data)
                                â”‚
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬6å±‚: æ•°æ®å­˜å‚¨ (TelemetryStorage)                                     â”‚
â”‚                                                                        â”‚
â”‚  å†…å­˜å­˜å‚¨:                                                             â”‚
â”‚    Map<DeviceId, List<TelemetryData>>                                â”‚
â”‚    deviceId â†’ [data1, data2, data3, ...]                             â”‚
â”‚                                                                        â”‚
â”‚  æ–‡ä»¶å¤‡ä»½:                                                             â”‚
â”‚    minitb/data/telemetry_xxx.log                                      â”‚
â”‚    [2024-10-23 21:05:30] {"temperature":25,"humidity":60}            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


å…³é”®ç±»åŠå…¶ä½œç”¨ï¼š
================================================================================

1. TbMsg                æ ¸å¿ƒæ¶ˆæ¯å¯¹è±¡ï¼Œè´¯ç©¿æ•´ä¸ªæ•°æ®æµ
2. TransportService     ä¼ è¾“å±‚åˆ°ä¸šåŠ¡å±‚çš„æ¡¥æ¢ï¼Œåˆ›å»ºTbMsg
3. RuleEngineService    è§„åˆ™å¼•æ“æ ¸å¿ƒï¼Œå¼‚æ­¥å¤„ç†å’Œè·¯ç”±
4. RuleChain            è§„åˆ™èŠ‚ç‚¹çš„ç»„åˆå™¨ï¼Œå®ç°è´£ä»»é“¾æ¨¡å¼
5. TelemetryStorage     æ•°æ®æŒä¹…åŒ–ï¼Œæ•°æ®æµçš„ç»ˆç‚¹


ä¸ThingsBoardçš„å…³é”®åŒºåˆ«ï¼š
================================================================================

ç»„ä»¶                  MiniTB              ThingsBoard
--------------------------------------------------------------------------------
æ¶ˆæ¯ä¼ é€’             ç›´æ¥è°ƒç”¨             Kafkaæ¶ˆæ¯é˜Ÿåˆ—
å¹¶å‘å¤„ç†             çº¿ç¨‹æ±                Actoræ¨¡å‹ (TenantActor â†’ RuleChainActor)
è§„åˆ™é“¾è·¯ç”±           if-else              åŸºäºå…³ç³»ç±»å‹è·¯ç”± (Success/Failure)
æ•°æ®å­˜å‚¨             å†…å­˜+æ–‡ä»¶            Cassandra/PostgreSQL + Redisç¼“å­˜
é›†ç¾¤æ”¯æŒ             å•æœº                 åˆ†å¸ƒå¼é›†ç¾¤ï¼Œæ°´å¹³æ‰©å±•


ä»£ç æ‰§è¡Œç¤ºä¾‹ï¼ˆæ¸©åº¦=25ï¼‰ï¼š
================================================================================

MqttTransportHandler.handlePublish()
  â†“ æå–: token="test-token-001", json={"temperature":25}
  
TransportService.processTelemetry(token, json)
  â†“ è®¤è¯: Device{name="æ¸©åº¦ä¼ æ„Ÿå™¨-01"}
  â†“ åˆ›å»º: TbMsg{type=POST_TELEMETRY_REQUEST, data=...}
  
RuleEngineService.processMessage(tbMsg)
  â†“ å¼‚æ­¥æäº¤å¤„ç†
  â†“ é€‰æ‹©: Root Rule Chain
  
RuleChain.process(tbMsg)
  â†“ LogNode: æ‰“å° "å…¥å£æ—¥å¿—"
  â†“ FilterNode: 25 > 20 âœ“ é€šè¿‡
  â†“ SaveTelemetryNode: ä¿å­˜æ•°æ®
  â†“ LogNode: æ‰“å° "ä¿å­˜å®Œæˆ"
  
TelemetryStorage.save()
  â†“ å†…å­˜: Mapä¿å­˜
  â†“ æ–‡ä»¶: å†™å…¥telemetry_xxx.log
  âœ“ å®Œæˆ


æ€§èƒ½å¯¹æ¯”ï¼š
================================================================================

MiniTB:
  â€¢ ååé‡: ~1,000 msg/s (å•æœº)
  â€¢ å»¶è¿Ÿ: <10ms (å†…å­˜)
  â€¢ å¹¶å‘: 4çº¿ç¨‹

ThingsBoard:
  â€¢ ååé‡: 100,000+ msg/s (é›†ç¾¤)
  â€¢ å»¶è¿Ÿ: ~50ms (å«Kafka+Cassandra)
  â€¢ å¹¶å‘: æ•°åƒActorå¹¶å‘å¤„ç†

