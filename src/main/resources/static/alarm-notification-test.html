<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘Šè­¦æ¨é€æµ‹è¯• - MiniTB</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #718096;
            font-size: 16px;
        }
        
        .status {
            display: inline-block;
            padding: 6px 12px;
            background: #48bb78;
            color: white;
            border-radius: 20px;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .status.disconnected {
            background: #fc8181;
        }
        
        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h2 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .log-container {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-left: 3px solid #4a5568;
        }
        
        .log-entry.info {
            border-left-color: #3b82f6;
        }
        
        .log-entry.success {
            border-left-color: #10b981;
        }
        
        .log-entry.error {
            border-left-color: #ef4444;
        }
        
        .log-time {
            color: #a0aec0;
            margin-right: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>
                ğŸ“¢ å‘Šè­¦æ¨é€æµ‹è¯•
                <span class="status" id="connectionStatus">â— è¿æ¥ä¸­...</span>
            </h1>
            <p>æµ‹è¯• SSE å®æ—¶å‘Šè­¦æ¨é€åŠŸèƒ½ - å‘Šè­¦ä¼šåœ¨å³ä¸Šè§’æ˜¾ç¤ºå¹¶åœ¨ 3 ç§’åè‡ªåŠ¨æ¶ˆå¤±</p>
        </div>
        
        <!-- å†…å®¹ -->
        <div class="content">
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="section">
                <h2>ğŸ“Š å®æ—¶ç»Ÿè®¡</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">å·²æ¥æ”¶å‘Šè­¦</div>
                        <div class="stat-value" id="receivedCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">SSE è¿æ¥çŠ¶æ€</div>
                        <div class="stat-value" id="connectionState">ç­‰å¾…ä¸­</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ€åæ¥æ”¶æ—¶é—´</div>
                        <div class="stat-value" style="font-size: 18px;" id="lastReceived">-</div>
                    </div>
                </div>
            </div>
            
            <!-- æµ‹è¯•æŒ‰é’® -->
            <div class="section">
                <h2>ğŸ§ª æ¨¡æ‹Ÿæµ‹è¯•</h2>
                <p style="color: #718096; margin-bottom: 15px;">
                    ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æ¨¡æ‹Ÿä¸åŒç±»å‹çš„å‘Šè­¦æ¨é€ï¼ˆä»…ç”¨äºå‰ç«¯UIæµ‹è¯•ï¼Œä¸ä¼šçœŸæ­£åˆ›å»ºå‘Šè­¦ï¼‰
                </p>
                <div class="test-buttons">
                    <button class="btn btn-danger" onclick="simulateAlarm('CRITICAL')">
                        ğŸ”´ æ¨¡æ‹Ÿ CRITICAL å‘Šè­¦
                    </button>
                    <button class="btn btn-warning" onclick="simulateAlarm('MAJOR')">
                        ğŸŸ  æ¨¡æ‹Ÿ MAJOR å‘Šè­¦
                    </button>
                    <button class="btn btn-primary" onclick="simulateAlarm('WARNING')">
                        ğŸ”µ æ¨¡æ‹Ÿ WARNING å‘Šè­¦
                    </button>
                    <button class="btn btn-primary" onclick="resendActiveAlarms()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        ğŸ“¡ æ¨é€å½“å‰æ´»åŠ¨å‘Šè­¦
                    </button>
                    <button class="btn btn-primary" onclick="clearLog()">
                        ğŸ§¹ æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
            </div>
            
            <!-- æ—¥å¿— -->
            <div class="section">
                <h2>ğŸ“‹ äº‹ä»¶æ—¥å¿—</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-entry info">
                        <span class="log-time">[ç­‰å¾…]</span> ç­‰å¾… SSE è¿æ¥å»ºç«‹...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let receivedCount = 0;
        let eventSource = null;
        
        // è¿æ¥ SSE
        function connectSSE() {
            logEvent('æ­£åœ¨è¿æ¥ SSE æœåŠ¡å™¨...', 'info');
            updateConnectionStatus('è¿æ¥ä¸­...', 'connecting');
            
            eventSource = new EventSource('/api/alarms/notifications/stream');
            
            // ç›‘å¬ alarm äº‹ä»¶
            eventSource.addEventListener('alarm', (event) => {
                receivedCount++;
                const alarm = JSON.parse(event.data);
                
                logEvent(`æ”¶åˆ°å‘Šè­¦: ${alarm.type} [${alarm.severity}] - ${alarm.deviceName}`, 'success');
                updateStats();
            });
            
            // onopen åœ¨æŸäº›æµè§ˆå™¨å¯èƒ½ä¸è§¦å‘ï¼Œä½¿ç”¨å®šæ—¶å™¨æ£€æŸ¥çŠ¶æ€
            eventSource.onopen = () => {
                logEvent('âœ… SSE è¿æ¥å·²å»ºç«‹', 'success');
                updateConnectionStatus('å·²è¿æ¥', 'connected');
            };
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼š2ç§’åæ£€æŸ¥è¿æ¥çŠ¶æ€
            setTimeout(() => {
                if (eventSource && eventSource.readyState === EventSource.OPEN) {
                    if (document.getElementById('connectionState').textContent !== 'å·²è¿æ¥') {
                        logEvent('âœ… SSE è¿æ¥å·²å»ºç«‹ï¼ˆçŠ¶æ€æ£€æŸ¥ï¼‰', 'success');
                        updateConnectionStatus('å·²è¿æ¥', 'connected');
                    }
                }
            }, 2000);
            
            eventSource.onerror = (error) => {
                logEvent('âŒ SSE è¿æ¥é”™è¯¯ï¼Œ5ç§’åé‡è¯•...', 'error');
                updateConnectionStatus('è¿æ¥æ–­å¼€', 'disconnected');
                
                eventSource.close();
                setTimeout(connectSSE, 5000);
            };
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(text, state) {
            const statusEl = document.getElementById('connectionStatus');
            const stateEl = document.getElementById('connectionState');
            
            statusEl.textContent = `â— ${text}`;
            stateEl.textContent = state === 'connected' ? 'å·²è¿æ¥' : 
                                  state === 'connecting' ? 'è¿æ¥ä¸­' : 'å·²æ–­å¼€';
            
            if (state === 'connected') {
                statusEl.className = 'status';
            } else {
                statusEl.className = 'status disconnected';
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('receivedCount').textContent = receivedCount;
            document.getElementById('lastReceived').textContent = new Date().toLocaleTimeString();
        }
        
        // è®°å½•æ—¥å¿—
        function logEvent(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ¨¡æ‹Ÿå‘Šè­¦ï¼ˆä»…ç”¨äºå‰ç«¯UIæµ‹è¯•ï¼‰
        function simulateAlarm(severity) {
            const alarm = {
                id: 'test-' + Date.now(),
                deviceId: 'test-device',
                deviceName: 'æµ‹è¯•è®¾å¤‡',
                type: 'æ¨¡æ‹Ÿå‘Šè­¦æµ‹è¯•',
                severity: severity,
                status: 'ACTIVE_UNACK',
                startTs: Date.now(),
                action: 'created'
            };
            
            logEvent(`æ¨¡æ‹Ÿå‘Šè­¦: ${alarm.type} [${severity}]`, 'info');
            
            // ç›´æ¥è°ƒç”¨é€šçŸ¥æœåŠ¡çš„æ˜¾ç¤ºæ–¹æ³•
            if (window.alarmNotificationService) {
                window.alarmNotificationService.showNotification(alarm);
                receivedCount++;
                updateStats();
            }
        }
        
        // æ¨é€å½“å‰æ´»åŠ¨å‘Šè­¦ï¼ˆè°ƒç”¨åç«¯ APIï¼‰
        function resendActiveAlarms() {
            logEvent('æ­£åœ¨è¯·æ±‚æ¨é€å½“å‰æ´»åŠ¨å‘Šè­¦...', 'info');
            
            fetch('/api/alarms/test/resend-active', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(data => {
                logEvent('âœ… ' + data, 'success');
            })
            .catch(error => {
                logEvent('âŒ æ¨é€å¤±è´¥: ' + error.message, 'error');
            });
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';
            logEvent('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè¿æ¥
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                connectSSE();
            }, 1000);
        });
    </script>
</body>
</html>

